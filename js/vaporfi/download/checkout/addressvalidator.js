var AddressValidator=Class.create();AddressValidator.prototype={formId:null,baseUrl:null,validationPassed:false,isRequestInProgress:false,popupContainerId:'address-validation-popup-wrapper',address:{addressId:null,validationFlag:1},initialize:function(formId,baseUrl){this.formId=formId;this.baseUrl=baseUrl;if(this.formId){var that=this;document.observe('dom:loaded',function(){that.initAddress();that.initEvents();if(!$(that.popupContainerId)){$$('body')[0].insert('<div id="'+that.popupContainerId+'"></div>')}});}},initAddress:function(){this.address.addressId=this.getAddressId();if(this.address.addressId){new Ajax.Request(this.baseUrl+'address/validationFlag',{method:'post',parameters:{address_id:this.address.addressId},onSuccess:function(transport){var response=transport.responseText.evalJSON();this.address.validationFlag=response.validation_flag;this.validationPassed=(response.validation_flag==2)?true:false;}.bind(this)});}},validate:function(){this.beforeValidate();if(this.validationPassed){return true;}else if(this.isRequestInProgress){return false;}else{var addressFields=this.getAddressFields();if(!addressFields.country_id.value.match(/us|pr/i)){return true;}
this.setLoadWaiting();this.isRequestInProgress=true;new Ajax.Request(this.baseUrl+'validation/validate',{method:'post',parameters:{street1:addressFields.street1.value,street2:addressFields.street2.value,city:addressFields.city.value,region_id:addressFields.region_id.value,region:addressFields.region.value,postcode:addressFields.postcode.value,country_id:addressFields.country_id.value},onSuccess:function(transport){var response=transport.responseText.evalJSON();this.isRequestInProgress=false;if(response.validation_passed){this.validationPassed=true;this.onAjaxValidationPassed();}else{this.resetLoadWaiting();this.showPopup(response.update_section.html);this.onClickPopupContinueButton(response.address);}}.bind(this)});return false;}},showPopup:function(html){this.beforeShowPopup();$(this.popupContainerId).update(html);html.evalScripts();},closePopup:function(){$('address-validation-popup').hide();$('address-validation-popup-mask').hide();},onClickPopupContinueButton:function(suggestedAddress){$('address-validation-popup-continue-button').observe('click',function(){var selection=$$('input:checked[type="radio"][name="address_validation_popup_option"]')[0].value;switch(selection){case'original':this.saveAddress(1);this.validationPassed=true;break;case'suggested':this.showAddressFields();this.fillAddressFields(suggestedAddress);this.saveAddress(2);this.validationPassed=true;break;case'edit':this.showAddressFields();this.validationPassed=false;}
this.closePopup();}.bind(this));},saveAddress:function(validationFlag){this.address.validationFlag=validationFlag;this.address.addressId=this.getAddressId();if(this.address.addressId){new Ajax.Request(this.baseUrl+'address/save',{method:'post',parameters:{address_id:this.address.addressId,validation_flag:this.address.validationFlag},onSuccess:function(transport){}});}},getAddressId:function(){return null;},fillAddressFields:function(address){var fields=this.getAddressFields();fields.street1.value=address.street[0];fields.street2.value=address.street[1];fields.city.value=address.city;fields.region_id.value=address.region_id;fields.region.value=address.region;fields.postcode.value=address.postcode;fields.country_id.value=address.country_id;this.afterFillAddressFields();},getAddressFields:function(){},setLoadWaiting:function(){},resetLoadWaiting:function(){},afterFillAddressFields:function(){},initEvents:function(){},showAddressFields:function(){},onAjaxValidationPassed:function(){},beforeValidate:function(){},beforeShowPopup:function(){}};Validation.addMethods({validate:function(){var result=false;var useTitles=this.options.useTitles;var callback=this.options.onElementValidate;try{if(this.options.stopOnFirst){result=Form.getElements(this.form).all(function(elm){if(elm.hasClassName('local-validation')&&!this.isElementInForm(elm,this.form)){return true;}
return Validation.validate(elm,{useTitle:useTitles,onElementValidate:callback});},this);}else{result=Form.getElements(this.form).collect(function(elm){if(elm.hasClassName('local-validation')&&!this.isElementInForm(elm,this.form)){return true;}
return Validation.validate(elm,{useTitle:useTitles,onElementValidate:callback});},this).all();}}catch(e){}
if(!result&&this.options.focusOnError){try{Form.getElements(this.form).findAll(function(elm){return $(elm).hasClassName('validation-failed')}).first().focus()}
catch(e){}}
this.options.onFormValidate(result,this.form);if(result==true&&addressValidator.formId==this.form.getAttribute('id')){result=addressValidator.validate();}
return result;}});